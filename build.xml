<?xml version="1.0" encoding="UTF-8"?>
<project name="sit-wt-all" basedir="." default="install">

  <property environment="env" />
  <property name="testArtifactId" value="sit-wt-test" />
  <property name="testdir" value="${basedir}/target/${testArtifactId}" />
  <property name="file.encoding" value="UTF-8" />

  <!-- TODO else~を修正 -->
  <condition property="mvn.cmd" value="${env.MAVEN_HOME}\bin\mvn.cmd" else="/usr/local/bin/mvn">
    <os family="windows" />
  </condition>


  <condition property="mvn.profile.ci" value="localhost,ci,release" else="">
    <isset property="ci" />
  </condition>


  <target name="install">
    <property name="mvn.phase" value="install" />
    <property name="mvn.repo" value="local.repositories" />
    <antcall target="all" />
  </target>


  <target name="deploy">
    <property name="mvn.phase" value="deploy" />
    <property name="mvn.repo" value="sonatype.repositories" />
    <antcall target="all" />
  </target>


  <target name="all">
    <antcall target="01_build" />
    <antcall target="02_acceptance-test" />
  </target>


  <target name="01_build" depends="check-test.skip">

    <exec executable="${mvn.cmd}" dir="${basedir}" failonerror="true">
      <env key="JAVA_HOME" value="${java.home}" />
      <arg value="-P" />
      <arg value="${mvn.repo},${mvn.profile.ci}" />
      <arg value="-Dmaven.test.skip=${test.skip}" />
      <arg value="-Dfile.encoding=${file.encoding}" />
      <arg value="clean" />
      <arg value="${mvn.phase}" />
    </exec>

  </target>


  <target name="check-test.skip" unless="test.skip">
    <input message="select maven.test.skip"
           addproperty="test.skip"
           validargs="true,false"
           defaultvalue="true" />
  </target>


  <target name="02_acceptance-test" depends="check-mvn.repo">

    <copy file="${basedir}/distribution/pom.xml" todir="${testdir}" />
    <copy file="${basedir}/sit-wt-runtime/testscript/CsvTestScript.csv" todir="${testdir}/testscript" />

    <exec executable="${mvn.cmd}" dir="${testdir}" failonerror="true">
      <env key="JAVA_HOME" value="${java.home}" />
      <arg value="-Devidence.open=false" />
      <arg value="-Dsample.baseUrl=file:///${basedir}/sit-wt-runtime/" />
      <arg value="-P" />
      <arg value="${mvn.repo}" />
      <arg value="-e" />
      <arg value="-Dfile.encoding=${file.encoding}" />
      <arg value="org.sitoolkit.wt:sit-wt-maven-plugin:sample" />
      <arg value="verify" />
    </exec>

  </target>


  <target name="check-mvn.repo" unless="mvn.repo">
    <input message="select mvn.repo"
           addproperty="mvn.repo"
           validargs="local.repositories,sonatype.repositores"
           defaultvalue="local.repositories" />
  </target>


  <target name="set-version">

    <property name="version" value="0.12.1-SNAPSHOT" />

    <replaceregexp file="${basedir}/distribution/pom.xml"
                   match="&lt;sitwt.version&gt;.*&lt;/sitwt.version&gt;"
                   replace="&lt;sitwt.version&gt;${version}&lt;/sitwt.version&gt;" />

    <exec executable="${mvn.cmd}" dir="${basedir}">
      <arg value="-DnewVersion=${version}" />
      <arg value="versions:set" />
    </exec>

  </target>

</project>
