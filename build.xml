<?xml version="1.0" encoding="UTF-8"?>
<project name="sit-wt-all" basedir="." default="install">

  <property environment="env" />
  <property name="testArtifactId" value="sit-wt-test" />
  <property name="testdir" value="${basedir}/target/${testArtifactId}" />
  <property name="file.encoding" value="UTF-8" />

  <condition property="mvn.cmd" value="${env.MAVEN_HOME}\bin\mvn.cmd" else="/usr/local/bin/mvn">
    <os family="windows" />
  </condition>


  <condition property="mvn.profile.ci" value="localhost,ci,release" else="">
    <isset property="ci" />
  </condition>


  <target name="install">
    <antcall target="01_commit-stage" />
    <antcall target="02_local-install-stage" />
    <antcall target="03_acceptance-stage" />
  </target>


  <target name="deploy">
    <antcall target="01_commit-stage" />
    <antcall target="02_local-install-stage" />
    <antcall target="03_acceptance-stage" />
    <antcall target="04_deploy-stage" />
  </target>


  <target name="01_commit-stage">

    <exec executable="${mvn.cmd}" dir="${basedir}" failonerror="true">
      <env key="JAVA_HOME" value="${java.home}" />
      <arg value="-P" />
      <arg value="localhost,ci" />
      <arg value="-Dfile.encoding=${file.encoding}" />
      <arg value="-Dmaven.test.skip=false" />
      <arg value="-Dmpir.skip=true" />
      <arg value="clean" />
      <arg value="site" />
    </exec>

  </target>

  
  <target name="02_local-install-stage">

    <exec executable="${mvn.cmd}" dir="${basedir}" failonerror="true">
      <env key="JAVA_HOME" value="${java.home}" />
      <arg value="-Dmaven.test.skip=true" />
      <arg value="clean" />
      <arg value="install" />
    </exec>

  </target>


  <target name="03_acceptance-stage">

    <copy file="${basedir}/distribution/pom.xml" todir="${testdir}" />
    <copy file="${basedir}/sit-wt-runtime/testscript/CsvTestScript.csv" todir="${testdir}/testscript" />

    <exec executable="${mvn.cmd}" dir="${testdir}" failonerror="true">
      <env key="JAVA_HOME" value="${java.home}" />
      <arg value="-Devidence.open=false" />
      <arg value="-Dsample.baseUrl=file:///${basedir}/sit-wt-runtime/" />
      <arg value="-e" />
      <arg value="-Dfile.encoding=${file.encoding}" />
      <arg value="org.sitoolkit.wt:sit-wt-maven-plugin:sample" />
      <arg value="verify" />
    </exec>

  </target>


  <target name="04_deploy-stage">

    <exec executable="${mvn.cmd}" dir="${basedir}" failonerror="true">
      <env key="JAVA_HOME" value="${java.home}" />
      <arg value="-P" />
      <arg value="release" />
      <arg value="-Dmaven.test.skip=true" />
      <arg value="clean" />
      <arg value="deploy" />
    </exec>

  </target>


  <target name="set-version">

    <property name="version" value="1.0-SNAPSHOT" />

    <replaceregexp file="${basedir}/distribution/pom.xml"
                   match="&lt;sitwt.version&gt;.*&lt;/sitwt.version&gt;"
                   replace="&lt;sitwt.version&gt;${version}&lt;/sitwt.version&gt;" />

    <exec executable="${mvn.cmd}" dir="${basedir}">
      <arg value="-DnewVersion=${version}" />
      <arg value="versions:set" />
    </exec>

  </target>

</project>
