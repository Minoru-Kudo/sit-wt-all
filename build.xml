<?xml version="1.0" encoding="UTF-8"?>
<project name="sit-wt-all" basedir="." default="install">

  <property environment="env" />
  <property name="testArtifactId" value="sit-wt-test" />
  <property name="testdir" value="${basedir}/target/${testArtifactId}" />
  <property name="file.encoding" value="UTF-8"/>

  <!-- TODO else~を修正 -->
  <condition property="mvn.cmd" value="${env.MAVEN_HOME}\bin\mvn.cmd" else="/usr/local/bin/mvn">
    <os family="windows" />
  </condition>

  <target name="install">
    <property name="mvn.phase" value="install" />
    <property name="mvn.repo" value="local.repositories" />
    <antcall target="all" />
  </target>


  <target name="deploy">
    <property name="mvn.phase" value="deploy" />
    <property name="mvn.repo" value="sonatype.repositories" />
    <antcall target="all" />
  </target>


  <target name="all">
    <antcall target="01_process-all" />
    <antcall target="02_process-archetype" />
    <antcall target="03_create-project" />
    <antcall target="04_integration-test" />
  </target>

  <target name="01_process-all" depends="check-test.skip">

    <exec executable="${mvn.cmd}" dir="${basedir}" failonerror="true">
      <env key="JAVA_HOME" value="${java.home}" />
      <arg value="-P" />
      <arg value="${mvn.repo}" />
      <arg value="-pl" />
      <arg value="!sit-wt-project-template,!sit-wt-project-template/distribution/archetype" />
      <arg value="-Dmaven.test.skip=${test.skip}" />
      <arg value="-Dfile.encoding=${file.encoding}" />
      <arg value="clean" />
      <arg value="${mvn.phase}" />
    </exec>

  </target>

  
  <target name="check-test.skip" unless="test.skip">
    <input message="select maven.test.skip"
           addproperty="mvn.repo"
           validargs="true,false"
           defaultvalue="true" />
  </target>
  

  <target name="02_process-archetype">

    <ant antfile="${basedir}/sit-wt-project-template/distribution/build.xml"
         target="${mvn.phase}"
         inheritall="false" />

  </target>


  <target name="03_create-project">

    <delete dir="${testdir}" />
    <mkdir dir="${testdir}" />

    <exec executable="${mvn.cmd}" dir="${basedir}/target" failonerror="true">
      <env key="JAVA_HOME" value="${java.home}" />
      <arg value="-DarchetypeGroupId=org.sitoolkit.wt" />
      <arg value="-DarchetypeArtifactId=sit-wt-project" />
      <arg value="-DarchetypeVersion=0.9-SNAPSHOT" />
      <arg value="-DgroupId=a.b.c" />
      <arg value="-DartifactId=${testArtifactId}" />
      <arg value="-Darchetype.interactive=false" />
      <arg value="-DarchetypeCatalog=local" />
      <arg value="-B" />
      <arg value="archetype:generate" />
    </exec>

  </target>


  <target name="04_integration-test" depends="check-mvn.repo">

    <copy file="${basedir}/sit-wt-runtime/seleniumscript/SeleniumIDETestScript.html"
          todir="${testdir}/seleniumscript" />
    <replace file="${testdir}/seleniumscript/SeleniumIDETestScript.html"
             token="http://localhost:8280/"
             value="" />
    <copy file="${basedir}/sit-wt-runtime/testscript/ExcelTestScript.xlsx"
          todir="${testdir}/testscript" />

    <exec executable="${mvn.cmd}" dir="${testdir}" resultproperty="testresult">
      <env key="JAVA_HOME" value="${java.home}" />
      <arg value="-DbaseUrl=${basedir}/sit-wt-runtime/src/main/webapp" />
      <arg value="-P" />
      <arg value="${mvn.repo}" />
      <arg value="-Dfile.encoding=${file.encoding}" />
      <arg value="clean" />
      <arg value="org.sitoolkit.wt:sit-wt-maven-plugin:selenium2script" />
      <arg value="integration-test" />
    </exec>

    <condition property="testfailed">
      <not>
        <equals arg1="${testresult}" arg2="0" />
      </not>
    </condition>
    <fail if="testfailed" message="integration test faild." />

  </target>


  <target name="check-mvn.repo" unless="mvn.repo">
    <input message="select mvn.repo"
           addproperty="mvn.repo"
           validargs="local.repositories,sonatype.repositores"
           defaultvalue="local.repositories" />
  </target>

</project>
